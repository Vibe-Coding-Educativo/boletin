<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolet√≠n Vibe Coding Educativo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind CSS Config -->
    <script>
        tailwind.config = {
          darkMode: 'class', // Habilita el modo oscuro basado en clases (ej: class="dark")
        }
    </script>
    
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Tailwind CSS CDN warning fix - for production use proper installation */
        /* This is development/demo version only */
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(245, 158, 11, 0.1), 0 4px 6px -2px rgba(245, 158, 11, 0.05);
        }
        .tag {
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .tag.active {
            background-color: #f59e0b; /* amber-500 */
            color: #1e293b; /* slate-800 */
        }
        .dark .tag.active {
            color: #ffffff;
        }
        .loader {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal transitions */
        #modal {
            transition: opacity 0.3s ease-in-out, backdrop-filter 0.3s ease-in-out;
            opacity: 0;
            backdrop-filter: blur(0px);
        }
        #modal.flex {
            opacity: 1;
            backdrop-filter: blur(4px);
        }
        #modal > div {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: scale(0.95) translateY(20px);
            opacity: 0;
        }
        #modal.flex > div {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* Reading mode transitions */
        #modal-sidebar {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                       opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                       transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
            opacity: 1;
        }
        .reading-mode #modal-sidebar {
            width: 0 !important;
            opacity: 0;
            transform: translateX(100%);
            overflow: hidden;
        }
        
        article {
            transition: max-width 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                       padding 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                       margin 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .reading-mode article {
            max-width: 65ch; /* Optimal reading width */
        }

        /* Smooth content fade */
        .content-fade-in {
            animation: fadeInContent 0.4s ease-out forwards;
        }
        @keyframes fadeInContent {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            function showLoader(show) { 
                const loader = document.getElementById('loader');
                if (loader) {
                    loader.style.display = show ? 'flex' : 'none'; 
                }
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced modal transitions */
        #modal {
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                       backdrop-filter 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            backdrop-filter: blur(0px);
        }
        #modal.flex {
            opacity: 1;
            backdrop-filter: blur(8px);
        }
        #modal > div {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                       opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(0.96) translateY(40px);
            opacity: 0;
        }
        #modal.flex > div {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* TOC Styles */
        .toc-item {
            display: block;
            padding: 0.5rem 0.75rem;
            color: #64748b;
            text-decoration: none;
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
            border-left: 3px solid transparent;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        .toc-item:hover {
            background-color: #f1f5f9;
            color: #f59e0b;
            border-left-color: #f59e0b;
            transform: translateX(4px);
        }
        .dark .toc-item {
            color: #94a3b8;
        }
        .dark .toc-item:hover {
            background-color: #334155;
            color: #fbbf24;
            border-left-color: #fbbf24;
        }
        .toc-item.toc-h1 {
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .toc-item.toc-h2 {
            padding-left: 1.5rem;
            font-weight: 500;
        }
        .toc-item.toc-h3 {
            padding-left: 2.25rem;
            font-size: 0.8125rem;
        }
        .toc-item.toc-h4 {
            padding-left: 3rem;
            font-size: 0.75rem;
        }

        /* Content transitions */
        #modal-body-content, #modal-faq-content, #modal-faq-mobile {
            transition: opacity 0.2s ease-in-out;
        }

        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }

        /* Header transitions */
        #modal .sticky {
            transition: background-color 0.2s ease-in-out, backdrop-filter 0.2s ease-in-out;
        }

        /* Button transitions */
        .read-more-btn, .expand-keywords, .collapse-keywords {
            transition: all 0.2s ease-in-out;
        }
        .read-more-btn:hover {
            transform: translateY(-1px);
        }
        .expand-keywords:hover, .collapse-keywords:hover {
            transform: scale(1.05);
        }

        /* Navigation buttons transitions */
        #nav-content, #nav-faq, #toggle-reading-mode {
            transition: color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        #nav-content:hover, #nav-faq:hover, #toggle-reading-mode:hover {
            transform: translateY(-1px);
        }

        /* Card animations */
        .card {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                       box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                       opacity 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(245, 158, 11, 0.1), 
                        0 10px 10px -5px rgba(245, 158, 11, 0.04);
        }

        /* Grid animations */
        #newsletter-grid {
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }
        #newsletter-grid.loaded {
            opacity: 1;
        }
        #newsletter-grid .card {
            animation: slideInUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(30px);
        }
        @keyframes slideInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Media container transitions */
        #modal-video-container {
            transition: padding 0.3s ease-in-out, margin 0.3s ease-in-out;
        }

        /* Light Theme Prose */
        .prose-custom { 
            color: #374151; 
            line-height: 1.8;
            font-size: 16px;
            transition: all 0.3s ease-in-out;
        }
        .prose-custom.prose-lg {
            font-size: 18px;
            line-height: 1.8;
        }
        .prose-custom.prose-sm {
            font-size: 14px;
            line-height: 1.7;
        }
        .prose-custom h1, .prose-custom h2, .prose-custom h3, .prose-custom h4, .prose-custom h5, .prose-custom h6 { 
            color: #111827; 
            font-weight: 700;
            margin-top: 2.5rem;
            margin-bottom: 1.25rem;
            line-height: 1.3;
            transition: color 0.2s ease-in-out;
        }
        .prose-custom h1 { 
            font-size: 2.5rem; 
            border-bottom: 3px solid #f59e0b; 
            padding-bottom: 0.75rem; 
            margin-top: 0;
            transition: border-color 0.2s ease-in-out, font-size 0.3s ease-in-out;
        }
        .prose-custom h2 { 
            font-size: 1.875rem; 
            border-bottom: 2px solid #fbbf24; 
            padding-bottom: 0.5rem;
            transition: border-color 0.2s ease-in-out, font-size 0.3s ease-in-out;
        }
        .prose-custom h3 { 
            font-size: 1.5rem; 
            color: #d97706;
            transition: color 0.2s ease-in-out, font-size 0.3s ease-in-out;
        }
        .prose-custom h4 { 
            font-size: 1.25rem; 
            color: #92400e;
            transition: color 0.2s ease-in-out, font-size 0.3s ease-in-out;
        }
        .prose-custom p { 
            margin-bottom: 1.5rem;
            transition: margin 0.2s ease-in-out;
        }
        .prose-custom ul, .prose-custom ol { 
            margin-bottom: 1.5rem; 
            padding-left: 1.75rem;
            transition: margin 0.2s ease-in-out, padding 0.2s ease-in-out;
        }
        .prose-custom li { 
            margin-bottom: 0.75rem;
            transition: margin 0.2s ease-in-out;
        }
        .prose-custom a { 
            color: #c2410c; 
            text-decoration: underline;
            transition: color 0.2s ease-in-out;
        }
        .prose-custom a:hover { color: #ea580c; }
        .prose-custom strong { 
            color: #a16207; 
            font-weight: 600;
            transition: color 0.2s ease-in-out;
        }
        .prose-custom blockquote { 
            border-left: 4px solid #f59e0b; 
            color: #4b5563; 
            margin: 2rem 0;
            padding-left: 1.5rem;
            font-style: italic;
            background-color: #fffbeb;
            padding: 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.1em;
            transition: all 0.3s ease-in-out;
        }
        .prose-custom code { 
            color: #be123c; 
            background-color: #f3f4f6; 
            padding: 0.25em 0.5em; 
            border-radius: 0.375rem;
            font-size: 0.875em;
            font-family: 'Roboto Mono', monospace;
            transition: all 0.2s ease-in-out;
        }
        .prose-custom pre { 
            background-color: #f3f4f6; 
            color: #374151;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin: 2rem 0;
            overflow-x: auto;
            transition: all 0.3s ease-in-out;
        }
        .prose-custom pre code {
            background-color: transparent;
            padding: 0;
        }

        /* Reading mode */
        .reading-mode #modal-sidebar {
            display: none !important;
        }
        .reading-mode article {
            max-width: 65ch; /* Optimal reading width */
        }

        /* Media container in new layout */
        #modal-video-container:not(:empty) {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            padding: 2rem;
            margin-bottom: 0;
        }
        .dark #modal-video-container:not(:empty) {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }

        /* Dark Theme Prose */
        .dark .prose-custom { color: #d1d5db; }
        .dark .prose-custom h1, .dark .prose-custom h2, .dark .prose-custom h3, .dark .prose-custom h4, .dark .prose-custom h5, .dark .prose-custom h6 { color: #f9fafb; }
        .dark .prose-custom h1 { border-bottom-color: #f59e0b; }
        .dark .prose-custom h2 { border-bottom-color: #fbbf24; }
        .dark .prose-custom h3 { color: #fbbf24; }
        .dark .prose-custom h4 { color: #fde047; }
        .dark .prose-custom a { color: #fb923c; }
        .dark .prose-custom a:hover { color: #fdba74; }
        .dark .prose-custom strong { color: #fde047; }
        .dark .prose-custom blockquote { 
            border-left-color: #f59e0b; 
            color: #9ca3af;
            background-color: #1f2937;
        }
        .dark .prose-custom code { color: #fda4af; background-color: #374151; }
        .dark .prose-custom pre { background-color: #1f2937; color: #d1d5db; }
        
        audio {
            filter: invert(0.1);
        }
        .dark audio {
            filter: invert(1) sepia(1) saturate(0.5) hue-rotate(180deg);
        }

    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <!-- Header -->
    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm shadow-lg sticky top-0 z-20 py-4 px-4 md:px-8">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white">
                    Bolet√≠n Semanal <a href="https://t.me/vceduca" target="_blank" rel="noopener noreferrer" class="text-amber-600 dark:text-amber-500 hover:underline">Vibe Coding Educativo</a>
                </h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">Resumen de conversaciones del grupo de Telegram</p>
            </div>
            <div class="flex items-center gap-4">
                <button id="theme-toggle" class="p-2 rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors" aria-label="Cambiar tema">
                    <!-- SVG icon will be injected here by JS -->
                </button>
                <select id="year-selector" class="bg-slate-200 dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100 rounded-md shadow-sm focus:border-amber-500 focus:ring focus:ring-amber-500 focus:ring-opacity-50"></select>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-8">

        <!-- Filters and Search -->
        <div class="mb-8 p-4 bg-white dark:bg-slate-800 rounded-lg shadow-md">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="search-input" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Buscar</label>
                    <input type="text" id="search-input" placeholder="Buscar por t√≠tulo, resumen..." class="w-full rounded-md shadow-sm bg-slate-200 dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100 focus:border-amber-500 focus:ring focus:ring-amber-500 focus:ring-opacity-50">
                </div>
                <div>
                    <label for="month-filter" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Filtrar por Mes</label>
                    <select id="month-filter" class="w-full rounded-md shadow-sm bg-slate-200 dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100 focus:border-amber-500 focus:ring focus:ring-amber-500 focus:ring-opacity-50">
                        <option value="">Todos los meses</option>
                    </select>
                </div>
                <div>
                    <label for="week-filter" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Filtrar por Semana</label>
                    <select id="week-filter" class="w-full rounded-md shadow-sm bg-slate-200 dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100 focus:border-amber-500 focus:ring focus:ring-amber-500 focus:ring-opacity-50">
                        <option value="">Todos las semanas</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loader" class="flex justify-center items-center py-20">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-slate-200 dark:border-slate-600 h-32 w-32" style="border-top-color: #f59e0b;"></div>
        </div>
        
        <!-- No Results Message -->
        <div id="no-results" class="text-center py-20 hidden">
            <h2 class="text-2xl font-bold text-slate-600 dark:text-slate-400">No se encontraron boletines</h2>
            <p class="text-slate-500 dark:text-slate-500 mt-2">Prueba a cambiar los filtros o el t√©rmino de b√∫squeda.</p>
        </div>

        <!-- Newsletter Grid -->
        <div id="newsletter-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 loaded"></div>
    </main>

    <!-- Modal for full newsletter -->
    <div id="modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-0">
        <div class="bg-white dark:bg-slate-900 w-full h-full flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 md:p-6 border-b border-slate-200 dark:border-slate-700 bg-white/95 dark:bg-slate-900/95 backdrop-blur-sm sticky top-0 z-10">
                <div class="flex-1 min-w-0">
                    <h2 id="modal-title" class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white truncate pr-4"></h2>
                    <p id="modal-date" class="text-sm text-amber-600 dark:text-amber-400 font-medium mt-1"></p>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Quick navigation -->
                    <nav class="hidden md:flex items-center gap-3 text-sm">
                        <button id="nav-content" class="text-slate-600 dark:text-slate-400 hover:text-amber-600 dark:hover:text-amber-400 transition-colors px-2 py-1 rounded hover:bg-slate-100 dark:hover:bg-slate-800">Contenido</button>
                        <span class="text-slate-300 dark:text-slate-600">|</span>
                        <button id="nav-faq" class="text-slate-600 dark:text-slate-400 hover:text-amber-600 dark:hover:text-amber-400 transition-colors px-2 py-1 rounded hover:bg-slate-100 dark:hover:bg-slate-800">FAQ</button>
                        <span class="text-slate-300 dark:text-slate-600">|</span>
                        <button id="toggle-reading-mode" class="text-slate-600 dark:text-slate-400 hover:text-amber-600 dark:hover:text-amber-400 transition-colors p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-800" title="Modo lectura">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                            </svg>
                        </button>
                    </nav>
                    <button id="modal-close" class="text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-white text-2xl p-1">&times;</button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="flex-1 overflow-hidden">
                <div class="h-full flex">
                    <!-- Main content area -->
                    <div class="flex-1 overflow-y-auto">
                        <div class="max-w-4xl mx-auto">
                            <!-- Media section -->
                            <div id="modal-video-container" class="w-full"></div>
                            
                            <!-- Article-style content -->
                            <article class="max-w-3xl mx-auto px-6 md:px-8 py-8">
                                <div id="modal-body-content" class="prose prose-custom prose-lg max-w-none"></div>
                            </article>
                        </div>
                    </div>
                    
                    <!-- Sidebar -->
                    <aside id="modal-sidebar" class="hidden lg:block w-80 bg-slate-50 dark:bg-slate-800/50 border-l border-slate-200 dark:border-slate-700 overflow-y-auto">
                        <div class="p-6">
                            <!-- Table of Contents -->
                            <div id="toc-section" class="hidden">
                                <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">√çndice de contenidos</h3>
                                <div id="modal-toc-content" class="space-y-2"></div>
                            </div>
                            
                            <!-- FAQ Section -->
                            <div id="faq-section">
                                <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Preguntas Frecuentes</h3>
                                <div id="modal-faq-content" class="prose prose-custom prose-sm max-w-none"></div>
                            </div>
                        </div>
                    </aside>
                </div>
                
                <!-- Mobile TOC and FAQ sections -->
                <section id="mobile-toc" class="lg:hidden border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 hidden">
                    <div class="max-w-3xl mx-auto px-6 md:px-8 py-8">
                        <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">√çndice de contenidos</h3>
                        <div id="modal-toc-mobile" class="space-y-2"></div>
                    </div>
                </section>
                
                <section id="mobile-faq" class="lg:hidden border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
                    <div class="max-w-3xl mx-auto px-6 md:px-8 py-8">
                        <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Preguntas Frecuentes</h3>
                        <div id="modal-faq-mobile" class="prose prose-custom max-w-none"></div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer id="page-footer" class="mt-12 py-6 border-t border-slate-200 dark:border-slate-700 text-center text-slate-500 dark:text-slate-400 text-sm">
        <p>Laboratorio de aplicaciones educativas - <a href="https://labia.tiddlyhost.com" target="_blank" class="hover:text-amber-600 dark:hover:text-amber-500">labia.tiddlyhost.com</a></p>
        <p>Aplicaci√≥n hecha por Juan Jos√© de Haro - <a href="https://bilateria.org" target="_blank" class="hover:text-amber-600 dark:hover:text-amber-500">bilateria.org</a></p>
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="hover:text-amber-600 dark:hover:text-amber-500">Licencia Creative Commons BY-SA</a></p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Configure marked.js to open all links in new tab
            const renderer = new marked.Renderer();
            renderer.link = function(href, title, text) {
                const titleAttr = title ? ` title="${title}"` : '';
                return `<a href="${href}"${titleAttr} target="_blank" rel="noopener noreferrer">${text}</a>`;
            };
            marked.setOptions({
                renderer: renderer,
                breaks: true,
                gfm: true
            });
            // --- THEME MANAGEMENT ---
            const themeToggle = document.getElementById('theme-toggle');
            const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`;
            const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`;
            const systemIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>`;

            function applyTheme(theme) {
                if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            function updateToggleIcon(theme) {
                if (theme === 'dark') {
                    themeToggle.innerHTML = moonIcon;
                } else if (theme === 'light') {
                    themeToggle.innerHTML = sunIcon;
                } else {
                    themeToggle.innerHTML = systemIcon;
                }
            }

            function cycleTheme() {
                const currentTheme = localStorage.getItem('theme') || 'system';
                let newTheme;
                if (currentTheme === 'system') newTheme = 'light';
                else if (currentTheme === 'light') newTheme = 'dark';
                else newTheme = 'system';
                
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
                updateToggleIcon(newTheme);
            }

            const savedTheme = localStorage.getItem('theme') || 'system';
            applyTheme(savedTheme);
            updateToggleIcon(savedTheme);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if (localStorage.getItem('theme') === 'system') {
                    applyTheme('system');
                }
            });
            themeToggle.addEventListener('click', cycleTheme);

            // --- State ---
            let allNewsletters = [];
            let activeKeywords = [];
            let expandedCards = new Set();
            let yearUrls = {};
            
            // --- Config URLs ---
            const CONFIG_URL = 'https://raw.githubusercontent.com/Vibe-Coding-Educativo/boletin/refs/heads/main/config.json';
            const CORS_PROXY = 'https://corsproxy.io/?';

            // --- Utility Functions ---
            const normalizeText = (text) => {
                if (!text) return '';
                return text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            };

            // --- Initialization ---
            async function init() {
                try {
                    const response = await fetch(CONFIG_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    yearUrls = await response.json();
                    
                    populateYearSelector();
                    
                    const yearSelector = document.getElementById('year-selector');
                    const selectedYear = yearSelector ? yearSelector.value : null;
                    if (selectedYear) {
                        await loadAndProcessData(selectedYear);
                    }
                } catch (error) {
                    console.error("Error initializing app:", error);
                    showError("No se pudo cargar la configuraci√≥n inicial.");
                }
            }

            function populateYearSelector() {
                const yearSelector = document.getElementById('year-selector');
                if (!yearSelector) return;
                
                const years = Object.keys(yearUrls).sort((a, b) => b - a);
                if (years.length === 0) {
                    showError("No se encontraron a√±os en la configuraci√≥n.");
                    return;
                }
                
                yearSelector.innerHTML = years.map(year => `<option value="${year}">${year}</option>`).join('');
                
                const currentYear = new Date().getFullYear().toString();
                if (years.includes(currentYear)) {
                    yearSelector.value = currentYear;
                }
            }

            async function loadAndProcessData(year) {
                const newsletterGrid = document.getElementById('newsletter-grid');
                const noResults = document.getElementById('no-results');
                
                showLoader(true);
                if (newsletterGrid) {
                    newsletterGrid.innerHTML = '';
                    newsletterGrid.classList.remove('loaded');
                }
                if (noResults) noResults.classList.add('hidden');
                expandedCards.clear(); // Reset expanded cards when loading new data
                
                const csvUrl = yearUrls[year];
                if (!csvUrl) {
                    showError(`No se encontr√≥ URL para el a√±o ${year}.`);
                    return;
                }

                try {
                    const response = await fetch(`${CORS_PROXY}${encodeURIComponent(csvUrl)}`);
                    if (!response.ok) throw new Error(`HTTP error fetching CSV! status: ${response.status}`);
                    const csvText = await response.text();

                    if (!csvText) throw new Error("El contenido del CSV est√° vac√≠o.");

                    allNewsletters = parseCSV(csvText);
                    
                    populateFilterOptions(allNewsletters);
                    applyFilters();

                } catch (error) {
                    console.error(`Error loading data for year ${year}:`, error);
                    showError(`No se pudo cargar los datos del bolet√≠n para el a√±o ${year}.`);
                } finally {
                    showLoader(false);
                }
            }
            
            function parseCSV(text) {
                const rows = [];
                let fields = [];
                let currentField = '';
                let inQuotes = false;

                text = text.trim() + '\n';

                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    const nextChar = text[i + 1];

                    if (inQuotes) {
                        if (char === '"' && nextChar === '"') {
                            currentField += '"';
                            i++;
                        } else if (char === '"') {
                            inQuotes = false;
                        } else {
                            currentField += char;
                        }
                    } else {
                        if (char === '"') {
                            inQuotes = true;
                        } else if (char === ',') {
                            fields.push(currentField);
                            currentField = '';
                        } else if (char === '\n' || char === '\r') {
                            if (nextChar === '\n' && char === '\r') i++;
                            
                            fields.push(currentField);
                            if (fields.length > 1 || (fields.length === 1 && fields[0] !== '')) {
                                rows.push(fields);
                            }
                            fields = [];
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                }

                return rows.slice(1).map(values => {
                    if (values.length < 9) return null;

                    const keywordsRaw = values.slice(8)
                        .flatMap(kwCell => kwCell.split(','))
                        .map(kw => kw.trim())
                        .filter(kw => kw);

                    return {
                        id: values[1].trim(),
                        dateInfo: parseIdToDateInfo(values[1].trim()),
                        title: values[3].trim(),
                        summary: values[4].trim(),
                        body: values[5].trim(),
                        link: values[6].trim(),
                        faq: values[7].trim(),
                        keywords: keywordsRaw
                    };
                }).filter(item => item && item.id).sort((a, b) => b.dateInfo.startDate - a.dateInfo.startDate);
            }

            function renderCards(newsletters) {
                const newsletterGrid = document.getElementById('newsletter-grid');
                const noResults = document.getElementById('no-results');
                
                if (!newsletterGrid || !noResults) return;
                
                // Fade out grid for smooth transition
                newsletterGrid.classList.remove('loaded');
                
                setTimeout(() => {
                    newsletterGrid.innerHTML = '';
                    if (newsletters.length === 0) {
                        noResults.classList.remove('hidden');
                        return;
                    }
                    noResults.classList.add('hidden');

                    newsletters.forEach((item, index) => {
                        const card = document.createElement('div');
                        card.className = 'card bg-white dark:bg-slate-800 rounded-lg overflow-hidden shadow-lg flex flex-col border border-slate-200 dark:border-slate-700';
                        card.style.animationDelay = `${index * 0.05}s`; // Stagger animation
                        
                        const mediaEmbedHTML = generateMediaEmbed(item.link);
                        const isExpanded = expandedCards.has(item.id);
                        const keywordsToShow = isExpanded ? item.keywords : item.keywords.slice(0, 3);
                        
                        const keywordTags = keywordsToShow.map(kw => {
                            const isActive = activeKeywords.includes(kw);
                            const activeClass = isActive ? 'bg-amber-500 text-slate-800 dark:text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-amber-100 hover:text-amber-700 dark:hover:bg-amber-900 dark:hover:text-amber-300';
                            return `<span class="tag text-xs px-2 py-0.5 rounded ${activeClass}">${kw}</span>`;
                        }).join('');
                        
                        const remainingCount = item.keywords.length - 3;
                        const expandButton = !isExpanded && remainingCount > 0 
                            ? `<span class="expand-keywords text-xs text-amber-600 dark:text-amber-400 hover:text-amber-500 cursor-pointer font-medium" data-card-id="${item.id}">+${remainingCount} m√°s</span>` 
                            : '';
                        
                        const collapseButton = isExpanded && item.keywords.length > 3
                            ? `<span class="collapse-keywords text-xs text-amber-600 dark:text-amber-400 hover:text-amber-500 cursor-pointer font-medium" data-card-id="${item.id}">mostrar menos</span>`
                            : '';

                        card.innerHTML = `
                            <div class="p-5 flex-grow flex flex-col">
                                <p class="text-sm text-amber-600 dark:text-amber-400 mb-1 font-semibold">${item.dateInfo.displayDate}</p>
                                <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-2">${item.title}</h3>
                                <p class="text-slate-600 dark:text-slate-300 text-sm mb-4 flex-grow">${item.summary}</p>
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${keywordTags}
                                    ${expandButton}
                                    ${collapseButton}
                                </div>
                            </div>
                            ${mediaEmbedHTML ? `
                            <div class="media-container p-4 bg-slate-100 dark:bg-slate-800/50 border-y border-slate-200 dark:border-slate-700">
                                ${mediaEmbedHTML}
                            </div>
                            ` : ''}
                            <div class="p-4 bg-slate-50 dark:bg-slate-800/50">
                                <button data-id="${item.id}" class="read-more-btn w-full text-center font-bold text-amber-600 hover:text-amber-500 dark:text-amber-500 dark:hover:text-amber-400 transition-colors">
                                    Ver cuerpo completo y FAQ &rarr;
                                </button>
                            </div>
                        `;
                        newsletterGrid.appendChild(card);
                    });
                    
                    // Fade in grid after cards are added
                    requestAnimationFrame(() => {
                        newsletterGrid.classList.add('loaded');
                    });
                }, 150); // Small delay for smooth transition
            }
            
            function populateFilterOptions(newsletters) {
                const monthFilter = document.getElementById('month-filter');
                const weekFilter = document.getElementById('week-filter');
                
                if (!monthFilter || !weekFilter) return;
                
                const months = new Set();
                const weeks = new Set();
                newsletters.forEach(item => {
                    const date = item.dateInfo.startDate;
                    if (!date || isNaN(date.getTime())) return;
                    months.add(date.getMonth());
                    weeks.add(getWeekNumber(date));
                });
                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                monthFilter.innerHTML = '<option value="">Todos los meses</option>' + [...months].sort((a,b) => a-b).map(m => `<option value="${m}">${monthNames[m]}</option>`).join('');
                weekFilter.innerHTML = '<option value="">Todas las semanas</option>' + [...weeks].sort((a,b) => a-b).map(w => `<option value="${w}">Semana ${w}</option>`).join('');
            }
            
            function applyFilters() {
                const searchInput = document.getElementById('search-input');
                const monthFilter = document.getElementById('month-filter');
                const weekFilter = document.getElementById('week-filter');
                
                if (!searchInput || !monthFilter || !weekFilter) return;
                
                const normalizedSearchTerm = normalizeText(searchInput.value);
                const selectedMonth = monthFilter.value;
                const selectedWeek = weekFilter.value;
                
                const filtered = allNewsletters.filter(item => {
                    try {
                        const date = item.dateInfo.startDate;
                        if (!date || isNaN(date.getTime())) return false;

                        const monthMatch = selectedMonth === '' || date.getMonth().toString() === selectedMonth;
                        const weekMatch = selectedWeek === '' || getWeekNumber(date).toString() === selectedWeek;
                        
                        const keywordMatch = activeKeywords.length === 0 || activeKeywords.every(ak => item.keywords.some(ik => normalizeText(ik) === normalizeText(ak)));

                        const searchMatch = normalizedSearchTerm === '' ||
                            normalizeText(item.title).includes(normalizedSearchTerm) ||
                            normalizeText(item.summary).includes(normalizedSearchTerm) ||
                            item.keywords.some(kw => normalizeText(kw).includes(normalizedSearchTerm));

                        return monthMatch && weekMatch && keywordMatch && searchMatch;
                    } catch (e) {
                        console.error("Error filtering item:", item, e);
                        return false;
                    }
                });
                renderCards(filtered);
            }
            
            function toggleKeywordFilter(keyword) {
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = '';
                }
                
                const keywordIndex = activeKeywords.indexOf(keyword);

                if (keywordIndex > -1) {
                    activeKeywords.splice(keywordIndex, 1);
                } else {
                    activeKeywords.push(keyword);
                }
                
                applyFilters();
            }
            
            function expandCardKeywords(cardId) {
                expandedCards.add(cardId);
                applyFilters(); // Re-render to show expanded keywords
            }
            
            function collapseCardKeywords(cardId) {
                expandedCards.delete(cardId);
                applyFilters(); // Re-render to show collapsed keywords
            }
            
            function openModal(id) {
                const item = allNewsletters.find(n => n.id === id);
                if (!item) return;
                
                const modal = document.getElementById('modal');
                if (!modal) return;
                
                // Set title and date using getElementById to avoid variable reference errors
                const titleElement = document.getElementById('modal-title');
                const dateElement = document.getElementById('modal-date');
                const bodyElement = document.getElementById('modal-body-content');
                const faqDesktopElement = document.getElementById('modal-faq-content');
                const faqMobileElement = document.getElementById('modal-faq-mobile');
                const videoElement = document.getElementById('modal-video-container');
                
                // First, fade out content for smooth loading
                [bodyElement, faqDesktopElement, faqMobileElement, videoElement].forEach(el => {
                    if (el) el.style.opacity = '0';
                });
                
                if (titleElement) titleElement.textContent = item.title;
                if (dateElement) dateElement.textContent = item.dateInfo.displayDate;
                
                // Show modal with transition
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // Force reflow to ensure hidden class is removed before adding flex
                modal.offsetHeight;
                
                // Add flex class for transition
                requestAnimationFrame(() => {
                    modal.classList.add('flex');
                });
                
                // Reset reading mode
                modal.classList.remove('reading-mode');
                
                // Load content with delay for smooth transition
                setTimeout(() => {
                    // Generate TOC from markdown
                    const headings = generateTableOfContents(item.body || '');
                    
                    // Set content with IDs for headings
                    if (bodyElement) {
                        let htmlContent = marked.parse(item.body || '*No hay contenido disponible.*');
                        htmlContent = addIdsToHeadings(htmlContent, headings);
                        bodyElement.innerHTML = htmlContent;
                        bodyElement.style.opacity = '1';
                        bodyElement.classList.add('content-fade-in');
                    }
                    
                    // Generate and render TOC
                    renderTableOfContents(headings, 'modal-toc-content');
                    renderTableOfContents(headings, 'modal-toc-mobile');
                    
                    // Set FAQ (both desktop sidebar and mobile)
                    const faqContent = marked.parse(item.faq || '*No hay preguntas frecuentes.*');
                    if (faqDesktopElement) {
                        faqDesktopElement.innerHTML = faqContent;
                        faqDesktopElement.style.opacity = '1';
                        faqDesktopElement.classList.add('content-fade-in');
                    }
                    if (faqMobileElement) {
                        faqMobileElement.innerHTML = faqContent;
                        faqMobileElement.style.opacity = '1';
                        faqMobileElement.classList.add('content-fade-in');
                    }
                    
                    // Set media
                    if (videoElement) {
                        videoElement.innerHTML = generateMediaEmbed(item.link, true);
                        videoElement.style.opacity = '1';
                        videoElement.classList.add('content-fade-in');
                    }
                    
                    // Default to showing FAQ
                    showFAQ();
                }, 200); // Slightly longer delay for smoother feel
            }

            function closeModal() {
                const modal = document.getElementById('modal');
                if (!modal) return;
                
                // Start transition by removing flex class
                modal.classList.remove('flex');
                
                // After transition, hide completely and restore scroll
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                }, 400); // Match the enhanced CSS transition duration
            }

            function generateTableOfContents(markdown) {
                const headings = [];
                const lines = markdown.split('\n');
                
                lines.forEach((line, index) => {
                    const match = line.match(/^(#{1,4})\s+(.+)/);
                    if (match) {
                        const level = match[1].length;
                        const text = match[2].trim();
                        const id = `heading-${index}-${text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`;
                        headings.push({ level, text, id });
                    }
                });
                
                return headings;
            }
            
            function addIdsToHeadings(html, headings) {
                let modifiedHtml = html;
                headings.forEach(heading => {
                    const headingRegex = new RegExp(`<h${heading.level}([^>]*)>(.*?${escapeRegex(heading.text)}.*?)<\/h${heading.level}>`, 'i');
                    modifiedHtml = modifiedHtml.replace(headingRegex, `<h${heading.level}$1 id="${heading.id}">$2</h${heading.level}>`);
                });
                return modifiedHtml;
            }
            
            function escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\            function showLoader(show) { 
                const loader = document.getElementById('loader');
                if (loader) {
                    loader.style.display = show ? 'flex' : 'none'; 
                }
            }');
            }
            
            function renderTableOfContents(headings, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                if (headings.length === 0) {
                    container.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-sm italic">No se encontraron secciones en este bolet√≠n.</p>';
                    return;
                }
                
                container.innerHTML = headings.map(heading => {
                    return `<a href="#${heading.id}" class="toc-item toc-h${heading.level}" data-heading-id="${heading.id}">${heading.text}</a>`;
                }).join('');
            }
            
            function showTableOfContents() {
                // Desktop
                const tocSection = document.getElementById('toc-section');
                const faqSection = document.getElementById('faq-section');
                if (tocSection) tocSection.classList.remove('hidden');
                if (faqSection) faqSection.classList.add('hidden');
                
                // Mobile
                const mobileToc = document.getElementById('mobile-toc');
                const mobileFaq = document.getElementById('mobile-faq');
                if (mobileToc) mobileToc.classList.remove('hidden');
                if (mobileFaq) mobileFaq.classList.add('hidden');
            }
            
            function showFAQ() {
                // Desktop
                const tocSection = document.getElementById('toc-section');
                const faqSection = document.getElementById('faq-section');
                if (tocSection) tocSection.classList.add('hidden');
                if (faqSection) faqSection.classList.remove('hidden');
                
                // Mobile
                const mobileToc = document.getElementById('mobile-toc');
                const mobileFaq = document.getElementById('mobile-faq');
                if (mobileToc) mobileToc.classList.add('hidden');
                if (mobileFaq) mobileFaq.classList.remove('hidden');
            }
            
            function showError(message) {
                const newsletterGrid = document.getElementById('newsletter-grid');
                if (newsletterGrid) {
                    newsletterGrid.innerHTML = `<div class="col-span-full text-center p-8 bg-red-800/20 text-red-500 dark:text-red-400 rounded-lg">${message}</div>`;
                }
                showLoader(false);
            }
            
            function parseIdToDateInfo(idString) {
                if (!idString || typeof idString !== 'string') {
                    return { startDate: null, endDate: null, displayDate: 'Fecha no disponible' };
                }
                const parts = idString.split('_');
                if (parts.length < 3) return { startDate: null, endDate: null, displayDate: idString };
                
                const startDate = new Date(parts[1]);
                const endDate = new Date(parts[2]);

                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                     return { startDate: null, endDate: null, displayDate: 'Fecha inv√°lida' };
                }

                const startDay = startDate.toLocaleDateString('es-ES', { day: 'numeric' });
                const startMonth = startDate.toLocaleDateString('es-ES', { month: 'long' });
                const endDay = endDate.toLocaleDateString('es-ES', { day: 'numeric' });
                const endMonth = endDate.toLocaleDateString('es-ES', { month: 'long' });
                const year = endDate.getFullYear();

                let displayDate;
                if (startMonth === endMonth) {
                    displayDate = `Semana del ${startDay} al ${endDay} de ${endMonth} de ${year}`;
                } else {
                    displayDate = `Semana del ${startDay} de ${startMonth} al ${endDay} de ${endMonth} de ${year}`;
                }
                
                return { startDate, endDate, displayDate };
            }

            function getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            }
            
            function getYouTubeID(url) {
                if(!url) return null;
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            }

            function generateMediaEmbed(link, fullSize = false) {
                if (!link) return '';
                
                const youtubeId = getYouTubeID(link);
                if (youtubeId) {
                    if (fullSize) {
                        return `<div class="relative w-full max-w-4xl mx-auto mb-8"><div class="relative pb-[56.25%] h-0"><iframe class="absolute top-0 left-0 w-full h-full rounded-lg shadow-lg" src="https://www.youtube.com/embed/${youtubeId}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div></div>`;
                    } else {
                        return `<iframe width="100%" height="95" class="rounded-md" src="https://www.youtube.com/embed/${youtubeId}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                    }
                }
                
                if (link.match(/\.(mp3|wav|ogg|m4a)$/i)) {
                    const type = link.match(/\.(mp3|wav|ogg|m4a)$/i)[1];
                    const audioElement = fullSize 
                        ? `<div class="w-full max-w-2xl mx-auto mb-8"><audio controls class="w-full"><source src="${link}" type="audio/${type === 'm4a' ? 'mp4' : type}">Tu navegador no soporta el elemento de audio.</audio></div>`
                        : `<audio controls class="w-full"><source src="${link}" type="audio/${type === 'm4a' ? 'mp4' : type}">Tu navegador no soporta el elemento de audio.</audio>`;
                    return audioElement;
                }

                if (link.includes('ivoox.com')) {
                    const embedLink = link.replace('_sq_f1', '_ep_1');
                    const ivooxElement = fullSize
                        ? `<div class="w-full max-w-2xl mx-auto mb-8"><iframe width="100%" height="200" scrolling="no" frameborder="0" allowfullscreen="" src="${embedLink}" class="rounded-lg shadow-lg"></iframe></div>`
                        : `<iframe width="100%" height="200" scrolling="no" frameborder="0" allowfullscreen="" src="${embedLink}"></iframe>`;
                    return ivooxElement;
                }

                return ''; // Return empty if no known media type is found
            }

            // --- Event Listeners ---
            document.body.addEventListener('click', function(event) {
                if (event.target.classList.contains('tag')) {
                    event.stopPropagation();
                    toggleKeywordFilter(event.target.textContent);
                }
                if (event.target.classList.contains('read-more-btn')) {
                    openModal(event.target.dataset.id);
                }
                if (event.target.classList.contains('expand-keywords')) {
                    event.stopPropagation();
                    expandCardKeywords(event.target.dataset.cardId);
                }
                if (event.target.classList.contains('collapse-keywords')) {
                    event.stopPropagation();
                    collapseCardKeywords(event.target.dataset.cardId);
                }
                // TOC navigation
                if (event.target.classList.contains('toc-item')) {
                    event.preventDefault();
                    const headingId = event.target.getAttribute('data-heading-id');
                    const targetElement = document.getElementById(headingId);
                    if (targetElement) {
                        // Find the scrollable modal content container
                        const modalContent = document.querySelector('#modal .overflow-y-auto');
                        if (modalContent) {
                            // Calculate position relative to modal content
                            const modalRect = modalContent.getBoundingClientRect();
                            const targetRect = targetElement.getBoundingClientRect();
                            const scrollTop = modalContent.scrollTop + (targetRect.top - modalRect.top) - 80; // 80px offset for header
                            
                            modalContent.scrollTo({
                                top: scrollTop,
                                behavior: 'smooth'
                            });
                        } else {
                            // Fallback
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                }
            });
            
            // Get elements for event listeners
            const yearSelector = document.getElementById('year-selector');
            const searchInput = document.getElementById('search-input');
            const monthFilter = document.getElementById('month-filter');
            const weekFilter = document.getElementById('week-filter');
            const modal = document.getElementById('modal');
            const modalClose = document.getElementById('modal-close');
            const navContent = document.getElementById('nav-content');
            const navFaq = document.getElementById('nav-faq');
            const toggleReadingModeBtn = document.getElementById('toggle-reading-mode');
            
            if (yearSelector) yearSelector.addEventListener('change', (e) => loadAndProcessData(e.target.value));
            if (searchInput) searchInput.addEventListener('input', applyFilters);
            if (monthFilter) monthFilter.addEventListener('change', applyFilters);
            if (weekFilter) weekFilter.addEventListener('change', applyFilters);
            if (modalClose) modalClose.addEventListener('click', closeModal);
            if (modal) {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            }
            document.addEventListener('keydown', (e) => { 
                if (e.key === "Escape" && modal && !modal.classList.contains('hidden')) closeModal(); 
            });
            
            // New modal navigation
            if (navContent) navContent.addEventListener('click', () => {
                // Visual feedback
                navContent.style.backgroundColor = 'rgb(245 158 11)';
                navContent.style.color = 'white';
                setTimeout(() => {
                    navContent.style.backgroundColor = '';
                    navContent.style.color = '';
                }, 200);
                
                // Reset reading mode first to ensure content is visible
                const modal = document.getElementById('modal');
                if (modal) modal.classList.remove('reading-mode');
                
                // Show table of contents
                showTableOfContents();
                
                // Scroll to sidebar in desktop or mobile TOC section
                const isDesktop = window.innerWidth >= 1024;
                if (isDesktop) {
                    const sidebar = document.getElementById('modal-sidebar');
                    if (sidebar) {
                        sidebar.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } else {
                    const mobileToc = document.getElementById('mobile-toc');
                    if (mobileToc) {
                        mobileToc.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            });
            
            if (navFaq) navFaq.addEventListener('click', () => {
                // Visual feedback
                navFaq.style.backgroundColor = 'rgb(245 158 11)';
                navFaq.style.color = 'white';
                setTimeout(() => {
                    navFaq.style.backgroundColor = '';
                    navFaq.style.color = '';
                }, 200);
                
                // Reset reading mode first to ensure FAQ is visible
                const modal = document.getElementById('modal');
                if (modal) modal.classList.remove('reading-mode');
                
                // Show FAQ
                showFAQ();
                
                // In desktop, scroll to sidebar; in mobile, scroll to mobile FAQ section
                const isDesktop = window.innerWidth >= 1024;
                let targetElement;
                
                if (isDesktop) {
                    targetElement = document.getElementById('modal-sidebar');
                } else {
                    targetElement = document.getElementById('mobile-faq');
                }
                
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
            if (toggleReadingModeBtn) toggleReadingModeBtn.addEventListener('click', () => {
                const modal = document.getElementById('modal');
                if (modal) {
                    modal.classList.toggle('reading-mode');
                    // Update tooltip text based on mode
                    const isReading = modal.classList.contains('reading-mode');
                    toggleReadingModeBtn.setAttribute('title', isReading ? 'Salir del modo lectura' : 'Modo lectura');
                }
            });
            
            // --- Start the application ---
            init();
        });
    </script>
</body>
</html>
